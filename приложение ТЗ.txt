1. Общая цель

Разработать локальное Python-приложение для работы с несколькими GGUF-моделями, поддерживающее:

Базовый автоматический пайплайн (по умолчанию)

Ручной режим конструирования обработки

Динамическое управление моделями

Многоуровневую обработку

Контроль ресурсов

Сохранение истории и промежуточных шагов

2. Режимы работы
2.1 Базовый пайплайн (режим по умолчанию)

Жёстко заданная структура:

User Question
   ↓
Model 1 + System Prompt 1
   ↓
Model 2 + System Prompt 2
   ↓
Models 3,4,5 + System Prompt 3 (параллельно или последовательно)
   ↓
Model 6 (aggregation / synthesis)
   ↓
Final Output
Требования:

Описывается в конфигурационном файле (pipeline.yaml)

Если одна из моделей базового пайплайна отсутствует:

Приложение выдаёт предупреждение

Базовый пайплайн становится недоступен

Должна быть возможность:

изменить порядок стадий через конфиг

менять параметры генерации

задавать несколько моделей на одном шаге

объединять их ответы

2.2 Ручной режим (Manual Construction Mode)

Пользователь может:

выбирать порядок стадий

выбирать модели для каждой стадии

использовать несколько моделей на одном шаге

задавать:

системный промпт

temperature

top_p

max_tokens

n_ctx

n_gpu_layers

выбирать способ объединения ответов:

конкатенация

голосование

синтез отдельной моделью

пользовательский агрегатор

Ручной режим работает даже если отсутствуют модели из базового пайплайна.

3. Управление моделями
3.1 Директория моделей

Модели хранятся:

/models/
    llama3_q5.gguf
    mistral_q4.gguf

Директория может находиться:

на локальном диске

на съёмном диске

Путь задаётся в конфиге.

3.2 Регистрация моделей

Есть файл:

config/models.yaml

В нём указывается:

models:
  llama3:
    file: llama3_q5.gguf
    default_n_ctx: 8192
    default_gpu_layers: 32
    description: "Llama 3 Q5"
3.3 Динамическое подключение

При запуске приложения:

Проверяется наличие директории моделей

Проверяется наличие файлов из models.yaml

Если файл отсутствует:

модель не регистрируется

она исчезает из интерфейса

логируется предупреждение

Исключение:

если модель используется в базовом пайплайне → базовый режим блокируется

3.4 Добавление новой модели

Чтобы добавить модель:

Поместить .gguf файл в директорию

Добавить запись в models.yaml

Перезапустить приложение

Модель автоматически появится в UI.

4. Управление ресурсами

Обязательно:

Проверка RAM

Проверка VRAM

Оценка возможности загрузки модели

Отказ при нехватке памяти

В ручном режиме при выборе нескольких моделей:

Перед запуском выполняется проверка:

влезут ли модели одновременно

Если нет:

предлагается sequential fallback

5. Обработка нескольких моделей на одном шаге

Поддержка:

Типы агрегации:

CONCAT

MAJORITY_VOTE

SYNTHESIS_MODEL

CUSTOM_TEMPLATE

Пример:

Step 3:
  models: [m3, m4, m5]
  aggregation: synthesis
  synthesis_model: m6
6. Хранение истории

Структура:

/sessions/
    session_001/
        config_snapshot.json
        step1.json
        step2.json
        step3_modelA.json
        step3_modelB.json
        aggregation.json
        final.txt

Сохраняется:

входной запрос

системные промпты

параметры генерации

ответы каждой модели

финальный ответ

информация о режиме

7. UI

Минимальный UI (Streamlit):

Должен позволять:

выбор режима (Base / Manual)

ввод запроса

выбор моделей

настройку параметров

просмотр промежуточных шагов

повторный запуск стадии

просмотр истории

8. Надёжность

Обработка отсутствующих моделей

Обработка CUDA OOM

Обработка нехватки RAM

Без падений приложения

Логирование ошибок

9. Расширяемость

В будущем можно добавить:

FastAPI слой

RAG модуль

Judge-модель

автоматическую оценку